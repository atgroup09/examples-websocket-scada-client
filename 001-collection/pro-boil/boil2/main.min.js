var G_WS_SERVER_URI="ws://at09.myddns.me:18106";var G_WS_SERVER_ID="WsLogBoil2";var G_WS_SERVER_STAMP=0;var G_WS=null;var G_WATCHDOG_TM=60;var G_WATCHDOG_TIMER=0;var G_WATCHDOG_DATA_STAMP=0;var G_WATCHDOG_DATA_LOGGED=false;var G_WATCHDOG_CONN_LOGGED=false;var G_POPUP_BASIC=null;var G_LANG="ru";var G_FORM_SET=null;var G_HMI=null;var G_DEBUG=false;var G_FIELD__ID="ID";var G_FIELD__STAMP="Stamp";var G_FIELD__NETWORKS="Networks";var G_FIELD__DEVICES="Devices";var G_LOG=null;var G_LOG_LIM_ROWS=100;function getWsServerState(){if(G_WS!=null){if(G_WS.readyState>=0||G_WS.readyState<4){return(G_WS.readyState)}}return(4)}function hasWsServerOpened(){var a=getWsServerState();return((a==1)?true:false)}function refreshWsServerDesc(){var a=getWsServerState();var b=null;b=$("#WsServerID");if(b){b.text(G_WS_SERVER_ID)}b=$("#WsServerUri");if(b){b.text(G_WS_SERVER_URI)}b=$("#WsServerState");if(b){b.text(G_RES[G_LANG]["ConnStates"][a])}var d=[$("#FormSetConnect"),$("#ConnectState")];for(var c=0;c<d.length;c++){if(d[c]){d[c].removeClass("ui-icon-disconnected");d[c].removeClass("ui-icon-connected");d[c].addClass(((a==1)?"ui-icon-connected":"ui-icon-disconnected"));d[c].text(((a==1)?G_RES[G_LANG]["Disconnect"]:G_RES[G_LANG]["Connect"]));d[c].attr("title",((a==1)?G_RES[G_LANG]["Disconnect"]:G_RES[G_LANG]["Connect"]))}}}function refreshHMI(a){if(a&&G_HMI){G_HMI.refresh(a)}}function closeWsServer(){if(G_WS){G_WS.close()}}function onWindowBeforeUnload(a){closeWsServer();return(null)}function onWebSocketOpened(a){G_WATCHDOG_DATA_LOGGED=false;G_WATCHDOG_CONN_LOGGED=false;G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["Connected"],null);printDebug(G_DEBUG,"CONNECTED");refreshWsServerDesc()}function onWebSocketClosed(a){if(!G_WATCHDOG_CONN_LOGGED){G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["Disconnected"],null);printDebug(G_DEBUG,"DISCONNECTED")}refreshWsServerDesc()}function isAnswerNet(a){if(typeof a=="object"&&typeof is_array=="function"){if(a){if(typeof a[G_FIELD__ID]=="string"&&typeof a[G_FIELD__STAMP]=="number"&&typeof a[G_FIELD__NETWORKS]=="object"){if(a[G_FIELD__ID]==G_WS_SERVER_ID){return(is_array(a[G_FIELD__NETWORKS]))}}}}return(false)}function isAnswerNetDev(a){if(typeof a=="object"&&typeof is_array=="function"){if(a){if(typeof a[G_FIELD__DEVICES]=="object"){return(is_array(a[G_FIELD__DEVICES]))}}}return(false)}function onWebSocketMsgReceived(d){var c=JSON.parse(d.data);printDebug(G_DEBUG,"MESSAGE: "+d.data);if(isAnswerNet(c)){G_WS_SERVER_STAMP=c[G_FIELD__STAMP];G_WATCHDOG_DATA_LOGGED=false;var b=0,a=0;for(b=0;b<c[G_FIELD__NETWORKS].length;b++){if(isAnswerNetDev(c[G_FIELD__NETWORKS][b])){printDebug(G_DEBUG,c[G_FIELD__NETWORKS][b]);for(a=0;a<c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES].length;a++){printDebug(G_DEBUG,c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES][a]);refreshHMI(c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES][a])}}}}}function onWebSocketErrReceived(b){if(!G_WATCHDOG_CONN_LOGGED){var a=G_RES[G_LANG]["SrvConnErr"].replace(/\{0\}/g,G_WS_SERVER_URI);printDebug(G_DEBUG,a);G_LOG.add(null,G_RES[G_LANG]["WebSocket"],a,"yellow");if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic(a)}}}function openWsServer(){try{if(typeof MozWebSocket=="function"){WebSocket=MozWebSocket}if(G_WS&&G_WS.readyState==1){G_WS.close()}if(!G_WS){window.onbeforeunload=onWindowBeforeUnload}if(typeof WebSocket!="undefined"){G_WS=new WebSocket(G_WS_SERVER_URI);G_WS.onopen=onWebSocketOpened;G_WS.onclose=onWebSocketClosed;G_WS.onmessage=onWebSocketMsgReceived;G_WS.onerror=onWebSocketErrReceived}else{printDebug(G_DEBUG,"Error! Websocket is not supported in your browser!");G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["WsNotSupportErr"],null);if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic(G_RES[G_LANG]["WsNotSupportErr"])}}}catch(a){printDebug(G_DEBUG,"Exception! "+a);G_LOG.add(null,G_RES[G_LANG]["WebSocket"],"Exception! "+a,null);if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic("Exception! "+a)}}}function onFormSetConnectClicked(b){var a=getWsServerState();G_WATCHDOG_DATA_LOGGED=false;G_WATCHDOG_CONN_LOGGED=false;if(a==0||a==1){closeWsServer()}else{openWsServer()}}function onFormSetLogClicked(c){var a=G_FORM_SET.getResultset();if(a){var b=((typeof a.log_use=="number")?true:false);G_LOG.toggleCase(b)}}function onWatchdogTimerElapsed(){var a=getWsServerState();var c=(a==0||a==1);if(G_WATCHDOG_DATA_STAMP==G_WS_SERVER_STAMP){if(!G_WATCHDOG_DATA_LOGGED){G_WATCHDOG_DATA_LOGGED=true;var b=G_RES[G_LANG]["NoDataErr"].replace(/\{0\}/g,G_WS_SERVER_URI);printDebug(G_DEBUG,b);G_LOG.add(null,G_RES[G_LANG]["WatchDog"],b,"yellow");if(!G_LOG.isCaseVisible()&&c){G_POPUP_BASIC.showBasic(b)}}}G_WATCHDOG_DATA_STAMP=G_WS_SERVER_STAMP;if(!c){if(!G_WATCHDOG_CONN_LOGGED){G_WATCHDOG_CONN_LOGGED=true;printDebug(G_DEBUG,"WatchdogConnect: Reconnect");G_LOG.add(null,G_RES[G_LANG]["WatchDog"],G_RES[G_LANG]["AutoReconnect"],null)}openWsServer()}}function writeToLog(a,c,j,g){if(typeof a=="object"&&typeof c=="number"&&typeof j=="string"){if(a&&j.length){var i=null;if(G_WS_SERVER_STAMP>0){var h=new Date();h.set_time_stamp(G_WS_SERVER_STAMP);i=h.format("isoDateTimeNorm")}var f=null;var k=a.attr("log-res-target");if(typeof k=="string"){f=((typeof G_RES[G_LANG][k]=="string")?G_RES[G_LANG][k]:null)}var e=null;if(typeof G_RES[G_LANG][j]!="undefined"){if(typeof G_RES[G_LANG][j][c]=="string"){e=G_RES[G_LANG][j][c]}}var d=a.attr("log-res-msg");if(typeof d=="string"){if(typeof G_RES[G_LANG][d][c]=="string"){e=G_RES[G_LANG][d][c]}}var b=((typeof g=="string")?g:null);G_LOG.add(i,f,e,b)}}}function onBitFuncWsLog(e,d,c,b,a){if(typeof e=="object"&&typeof d=="number"&&typeof b=="string"){writeToLog(e,d,b,null)}return(true)}function onBitFuncWsRedLog(e,d,c,b,a){if(typeof e=="object"&&typeof d=="number"&&typeof b=="string"){writeToLog(e,d,b,"red")}return(true)}function onBitFuncWsYellowLog(e,d,c,b,a){if(typeof e=="object"&&typeof d=="number"&&typeof b=="string"){writeToLog(e,d,b,"yellow")}return(true)}function onBitFuncWsGreenLog(e,d,c,b,a){if(typeof e=="object"&&typeof d=="number"&&typeof b=="string"){writeToLog(e,d,b,"green")}return(true)}function initPopupBasic(){if(typeof jsPopupDialog=="function"){G_POPUP_BASIC=new jsPopupDialog("PopupBasic")}}function initFormSet(){if(typeof jsForm=="function"){G_FORM_SET=new jsForm("FormSet");G_FORM_SET.ItemOptions={log_use:{ItemType:"checkbox",DataType:"number",Allow:true}};$("#FormSetConnect").bind("click",onFormSetConnectClicked);$("#FormSetLog").bind("click",onFormSetLogClicked);G_FORM_SET.AutoCreate=true}}function initUI(){if(typeof HMI=="function"){G_HMI=new HMI();G_HMI.Options={Y1Al:{DataKey:"WsDI",Type:"BitLampBlink",Bit:9,Inverted:true},Y1St:{DataKey:"WsDI",Type:"BitLamp",Bit:9},PwrAl:{DataKey:"WsDI",Type:"BitLampBlink",Bit:8,Inverted:true},PwrSt:{DataKey:"WsDI",Type:"BitLamp",Bit:8},B1Al:{DataKey:"WsDI",Type:"BitLampBlink",AndMask:21,Not:true},B1St:{DataKey:"WsDI",Type:"BitLamp",Bit:0},B1Fi:{DataKey:"WsDI",Type:"BitLamp",Bit:2},B2Al:{DataKey:"WsDI",Type:"BitLampBlink",AndMask:42,Not:true},B2St:{DataKey:"WsDI",Type:"BitLamp",Bit:1},B2Fi:{DataKey:"WsDI",Type:"BitLamp",Bit:3},H1St:{DataKey:"WsDI",Type:"BitLamp",Bit:6},H2St:{DataKey:"WsDI",Type:"BitLamp",Bit:7},Pres:{DataKey:"Pres",Type:"Number",Offset:10,Round:1},Pret:{DataKey:"Pret",Type:"Number",Offset:10,Round:1},Pext:{DataKey:"Pext",Type:"Number",Offset:10,Round:1},Tres:{DataKey:"Tres",Type:"Number",Offset:10,Round:1},Tret:{DataKey:"Tret",Type:"Number",Offset:10,Round:1},Tloc:{DataKey:"Tloc",Type:"Number",Offset:10,Round:1},PwrOffLog:{DataKey:"WsDI",Type:"BitFunc",AndMask:256,BoolNum:true,RiseEdge:true,BitFunc:onBitFuncWsRedLog,NodeID:"PwrAl",Not:true},Y1OffLog:{DataKey:"WsDI",Type:"BitFunc",AndMask:512,BoolNum:true,RiseEdge:true,BitFunc:onBitFuncWsRedLog,NodeID:"Y1Al",Not:true},Ps1AlLog:{DataKey:"WsDI",Type:"BitFunc",AndMask:16,BoolNum:true,RiseEdge:true,BitFunc:onBitFuncWsRedLog,NodeID:"Ps1Al",Not:true},Ps2AlLog:{DataKey:"WsDI",Type:"BitFunc",AndMask:32,BoolNum:true,RiseEdge:true,BitFunc:onBitFuncWsRedLog,NodeID:"Ps2Al",Not:true},B1AlLog:{DataKey:"WsDI",Type:"BitFunc",AndMask:1,BoolNum:true,RiseEdge:true,BitFunc:onBitFuncWsRedLog,NodeID:"B1Al",Not:true},B2AlLog:{DataKey:"WsDI",Type:"BitFunc",AndMask:2,BoolNum:true,RiseEdge:true,BitFunc:onBitFuncWsRedLog,NodeID:"B2Al",Not:true},Fi1AlLog:{DataKey:"WsDI",Type:"BitFunc",AndMask:4,BoolNum:true,RiseEdge:true,BitFunc:onBitFuncWsRedLog,NodeID:"B1Fi",Not:true},Fi2AlLog:{DataKey:"WsDI",Type:"BitFunc",AndMask:8,BoolNum:true,RiseEdge:true,BitFunc:onBitFuncWsRedLog,NodeID:"B2Fi",Not:true}};G_HMI.DefaultValue=G_RES[G_LANG]["None"];G_HMI.init()}if(typeof jsLog=="function"){G_LOG=new jsLog("LogTable");G_LOG.LimRows=G_LOG_LIM_ROWS;G_LOG.AllowRotate=true;G_LOG.AllowCurrentStamp=true;G_LOG.CaseID="LogCase"}initPopupBasic();initFormSet();refreshWsServerDesc();$("#FormSetConnect").trigger("click");G_WATCHDOG_TIMER=setInterval(onWatchdogTimerElapsed,G_WATCHDOG_TM*1000)};