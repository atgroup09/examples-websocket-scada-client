var G_WS_SERVER_URI="ws://at09.myddns.me:18103";var G_WS_SERVER_ID="WsLogComp";var G_WS_SERVER_STAMP=0;var G_WS=null;var G_WATCHDOG_TM=60;var G_WATCHDOG_TIMER=0;var G_WATCHDOG_DATA_STAMP=0;var G_WATCHDOG_DATA_LOGGED=false;var G_WATCHDOG_CONN_LOGGED=false;var G_POPUP_BASIC=null;var G_ROOT_CASE="RootCase";var G_LANG="ru";var G_FORM_SET=null;var G_HMI=null;var G_AL_IMG="images/warning-1.png";var G_AL_IMG_WIDTH=128;var G_AL_IMG_HEIGHT=128;var G_DEBUG=false;var G_FIELD__ID="ID";var G_FIELD__STAMP="Stamp";var G_FIELD__NETWORKS="Networks";var G_FIELD__DEVICES="Devices";var G_LOG=null;function getNodeID(d,a,b){var c=null;if(typeof d=="object"&&typeof b=="string"){if(d){if(typeof d.ID=="string"||typeof d.ID=="number"){switch(b){case"case":case"case-bar":c=((typeof d.PreID=="string")?(d.PreID+d.ID):d.ID);if(b=="case-bar"){c+="Bar"}break;case"case-table-row":case"bitlampblink":if(typeof a=="object"){if(a){if(typeof a.PreID=="string"){if(a.PreID.length){c=(a.PreID+d.ID);if(b=="bitlampblink"){c+="BitLampBlink"}}}}}}}}}return(c)}function addCaseBitLampBlink(f,e,d){var h=0;if(f&&d&&typeof is_array=="function"){if(is_array(d)){var b=null;var a=(f[0].offsetLeft+(f[0].offsetWidth/2)-(G_AL_IMG_WIDTH/2));var g=(f[0].offsetTop+(f[0].offsetHeight/2)-(G_AL_IMG_HEIGHT/2));for(var c=0;c<d.length;c++){if(d[c]){NodeID=getNodeID(e,d[c],"bitlampblink");if(NodeID){b=$('<div hmi="bitlampblink" id="'+NodeID+'" style="position:absolute;left:'+a+"px;top:"+g+'px;z-index:200;display:none;"><img src="'+G_AL_IMG+'" /></div>');b.appendTo(f);h++;if(G_HMI&&typeof d[c]["HmiOptions"]=="object"){G_HMI.setOptionsFrom(NodeID,e.ID,d[c]["HmiOptions"])}}}}}}return(h)}function addCaseTableRows(a,b,c){var f=0;if(a&&c&&typeof is_array=="function"){if(is_array(c)){var h=a.find("tbody");if(h){var k=null;var d=false;var g=null;var j=null;for(var e=0;e<c.length;e++){if(c[e]){k=getNodeID(b,c[e],"case-table-row");if(k){if(typeof c[e]["Colspan"]=="boolean"){d=c[e]["Colspan"]}if(!d){j="ui-table-title ui-table-td-55";if(typeof c[e]["Kpi"]=="boolean"){if(c[e]["Kpi"]){j+=" ui-kpi"}}g=$('<tr hmi="case-table-row"><td class="'+j+'"'+((typeof c[e]["Title_t"]=="string")?'title="'+c[e]["Title_t"]+'"':"")+">"+((typeof c[e]["Title"]=="string")?c[e]["Title"]:G_RES[G_LANG]["None"])+'</td><td hmi="value" class="ui-table-td-30" id="'+k+'">---</td><td class="ui-table-title ui-table-td-15">'+((typeof c[e]["MUnit"]=="string")?c[e]["MUnit"]:G_RES[G_LANG]["None"])+"</td></tr>")}else{g=$('<tr hmi="case-table-row"><td hmi="value" colspan="3" id="'+k+'">---</td></tr>')}g.appendTo(h);f++;if(G_HMI&&typeof c[e]["HmiOptions"]=="object"){G_HMI.setOptionsFrom(k,b.ID,c[e]["HmiOptions"])}}}}}}}return(f)}function newCaseTable(){var a=$('<table hmi="case-table" class="ui-table-z"><caption /><thead /><tfoot /><tbody></tbody></table>');return(a)}function newCase(d){var c=null;var b=getNodeID(d,null,"case");var a=getNodeID(d,null,"case-bar");if(b&&a){c=$('<div hmi="case" class="ui-block-a" id="'+b+'"><div hmi="case-bar" class="ui-bar ui-bar-a" id="'+a+'"><div class="ui-corner-all custom-corners"><div class="ui-bar ui-bar-y"><h3>'+((typeof d.Title=="string")?d.Title:G_RES[G_LANG]["None"])+'</h3></div><div hmi="case-body" class="ui-body ui-body-a"></div></div></div></div>');if(G_HMI&&typeof d.HmiOptions=="object"){G_HMI.setOptionsFrom(a,d.ID,d.HmiOptions)}}return(c)}function initCases(h,j,c){if(typeof h=="object"&&typeof j=="object"&&typeof is_array=="function"){if(h&&is_array(j)){var a=["a","b","c","d"];var l=0;var k=null;var b=null;var e=false;var f=false;var g=null;for(var d=0;d<j.length;d++){if(j[d]){k=newCase(j[d]);if(k){k.attr("class",("ui-block-"+a[l]));l=((l<a.length-1)?(l+1):0);e=false;UseBitLamps=false;if(typeof j[d]["Class"]=="string"&&typeof c=="object"){if(c){b=j[d]["Class"];if(typeof c[b]=="object"){if(c[b]){if(typeof c[b]["TableRows"]=="object"){if(c[b]["TableRows"]){e=true}}if(typeof c[b]["BitLampBlink"]=="object"){if(c[b]["BitLampBlink"]){f=true}}}}}}if(e){g=newCaseTable();g=k.find("div[hmi='case-body']").append(g);addCaseTableRows(g,j[d],c[b]["TableRows"])}k=k.appendTo(h);k.trigger("create");if(f){addCaseBitLampBlink(k,j[d],c[b]["BitLampBlink"])}}}}}}}function getTargetBlockNode(a){printDebug(G_DEBUG,"#TargetBlock"+a);return((a>=0&&a<G_TARGETS.length)?($("#TargetBlock"+a)):null)}function getTargetBarNode(c){var b=getTargetBlockNode(c);if(b){printDebug(G_DEBUG,"Block.class = "+b.attr("class"));var a=b.find("div[class^='ui-bar ui-bar-a']");if(a){return(a)}}return(null)}function getWsServerState(){if(G_WS!=null){if(G_WS.readyState>=0||G_WS.readyState<4){return(G_WS.readyState)}}return(4)}function hasWsServerOpened(){var a=getWsServerState();return((a==1)?true:false)}function refreshWsServerDesc(){var a=getWsServerState();var b=null;b=$("#WsServerID");if(b){b.text(G_WS_SERVER_ID)}b=$("#WsServerUri");if(b){b.text(G_WS_SERVER_URI);b.attr("title",G_WS_SERVER_URI)}b=$("#WsServerState");if(b){b.text(G_RES[G_LANG]["ConnStates"][a])}var d=[$("#FormSetConnect"),$("#ConnectState")];for(var c=0;c<d.length;c++){if(d[c]){d[c].removeClass("ui-icon-disconnected");d[c].removeClass("ui-icon-connected");d[c].addClass(((a==1)?"ui-icon-connected":"ui-icon-disconnected"));d[c].text(((a==1)?G_RES[G_LANG]["Disconnect"]:G_RES[G_LANG]["Connect"]));d[c].attr("title",((a==1)?G_RES[G_LANG]["Disconnect"]:G_RES[G_LANG]["Connect"]))}}}function refreshHMI(a){if(a&&G_HMI){G_HMI.refresh(a)}}function closeWsServer(){if(G_WS){G_WS.close()}}function onWindowBeforeUnload(a){closeWsServer();return(null)}function onWebSocketOpened(a){G_WATCHDOG_DATA_LOGGED=false;G_WATCHDOG_CONN_LOGGED=false;G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["Connected"],null);printDebug(G_DEBUG,"CONNECTED");refreshWsServerDesc()}function onWebSocketClosed(a){if(!G_WATCHDOG_CONN_LOGGED){G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["Disconnected"],null);printDebug(G_DEBUG,"DISCONNECTED")}refreshWsServerDesc()}function isAnswerNet(a){if(typeof a=="object"&&typeof is_array=="function"){if(a){if(typeof a[G_FIELD__ID]=="string"&&typeof a[G_FIELD__STAMP]=="number"&&typeof a[G_FIELD__NETWORKS]=="object"){if(a[G_FIELD__ID]==G_WS_SERVER_ID){return(is_array(a[G_FIELD__NETWORKS]))}}}}return(false)}function isAnswerNetDev(a){if(typeof a=="object"&&typeof is_array=="function"){if(a){if(typeof a[G_FIELD__DEVICES]=="object"){return(is_array(a[G_FIELD__DEVICES]))}}}return(false)}function onWebSocketMsgReceived(d){var c=JSON.parse(d.data);printDebug(G_DEBUG,"MESSAGE: "+d.data);if(isAnswerNet(c)){G_WS_SERVER_STAMP=c[G_FIELD__STAMP];G_WATCHDOG_DATA_LOGGED=false;var b=0,a=0;for(b=0;b<c[G_FIELD__NETWORKS].length;b++){if(isAnswerNetDev(c[G_FIELD__NETWORKS][b])){printDebug(G_DEBUG,c[G_FIELD__NETWORKS][b]);for(a=0;a<c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES].length;a++){printDebug(G_DEBUG,c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES][a]);refreshHMI(c[G_FIELD__NETWORKS][b][G_FIELD__DEVICES][a])}}}}}function onWebSocketErrReceived(b){if(!G_WATCHDOG_CONN_LOGGED){var a=G_RES[G_LANG]["SrvConnErr"].replace(/\{0\}/g,G_WS_SERVER_URI);printDebug(G_DEBUG,a);G_LOG.add(null,G_RES[G_LANG]["WebSocket"],a,"yellow");if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic(a)}}}function openWsServer(){try{if(typeof MozWebSocket=="function"){WebSocket=MozWebSocket}if(G_WS&&G_WS.readyState==1){G_WS.close()}if(!G_WS){window.onbeforeunload=onWindowBeforeUnload}if(typeof WebSocket!="undefined"){G_WS=new WebSocket(G_WS_SERVER_URI);G_WS.onopen=onWebSocketOpened;G_WS.onclose=onWebSocketClosed;G_WS.onmessage=onWebSocketMsgReceived;G_WS.onerror=onWebSocketErrReceived}else{printDebug(G_DEBUG,"Error! Websocket is not supported in your browser!");G_LOG.add(null,G_RES[G_LANG]["WebSocket"],G_RES[G_LANG]["WsNotSupportErr"],null);if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic(G_RES[G_LANG]["WsNotSupportErr"])}}}catch(a){printDebug(G_DEBUG,"Exception! "+a);G_LOG.add(null,G_RES[G_LANG]["WebSocket"],"Exception! "+a,null);if(!G_LOG.isCaseVisible()){G_POPUP_BASIC.showBasic("Exception! "+a)}}}function onFormSetConnectClicked(b){var a=getWsServerState();G_WATCHDOG_DATA_LOGGED=false;G_WATCHDOG_CONN_LOGGED=false;if(a==0||a==1){closeWsServer()}else{openWsServer()}}function onFormSetLogClicked(c){var a=G_FORM_SET.getResultset();if(a){var b=((typeof a.log_use=="number")?true:false);G_LOG.toggleCase(b)}}function onWatchdogTimerElapsed(){var a=getWsServerState();var c=(a==0||a==1);if(G_WATCHDOG_DATA_STAMP==G_WS_SERVER_STAMP){if(!G_WATCHDOG_DATA_LOGGED){G_WATCHDOG_DATA_LOGGED=true;var b=G_RES[G_LANG]["NoDataErr"].replace(/\{0\}/g,G_WS_SERVER_URI);printDebug(G_DEBUG,b);G_LOG.add(null,G_RES[G_LANG]["WatchDog"],b,"yellow");if(!G_LOG.isCaseVisible()&&c){G_POPUP_BASIC.showBasic(b)}}}G_WATCHDOG_DATA_STAMP=G_WS_SERVER_STAMP;if(!c){if(!G_WATCHDOG_CONN_LOGGED){G_WATCHDOG_CONN_LOGGED=true;printDebug(G_DEBUG,"WatchdogConnect: Reconnect");G_LOG.add(null,G_RES[G_LANG]["WatchDog"],G_RES[G_LANG]["AutoReconnect"],null)}openWsServer()}}function onBitFuncAlarmLog(e,a){if(typeof e=="object"&&typeof a=="number"){if(e&&a>0){var d=null;var b=e.find("h3").text();var c=G_RES[G_LANG]["AlarmTitleStates"][a];if(G_WS_SERVER_STAMP>0){var f=new Date();f.set_time_stamp(G_WS_SERVER_STAMP);d=f.format("isoDateTimeNorm")}G_LOG.add(d,b,c,"red")}}return(true)}function initPopupBasic(){if(typeof jsPopupDialog=="function"){G_POPUP_BASIC=new jsPopupDialog("PopupBasic")}}function initFormSet(){if(typeof jsForm=="function"){G_FORM_SET=new jsForm("FormSet");G_FORM_SET.ItemOptions={log_use:{ItemType:"checkbox",DataType:"number",Allow:true}};$("#FormSetConnect").bind("click",onFormSetConnectClicked);$("#FormSetLog").bind("click",onFormSetLogClicked);G_FORM_SET.AutoCreate=true}}function initUI(){var b=[{ID:1,Title:"K1::"+G_RES[G_LANG]["Den200"],Class:"Compressor",PreID:"Case",HmiOptions:[{PreDataKey:"St",Type:"ArrayIDx",Arr:G_RES[G_LANG]["CompClassStates"],NodeAttr:"class",DefaultValue:"ui-bar ui-bar-a ui-state-stop"},{PreDataKey:"Al",Type:"BitFunc",Func:onBitFuncAlarmLog,DefaultValue:0,RiseEdge:true}]},{ID:2,Title:"K2::"+G_RES[G_LANG]["Eko"],Class:"Compressor",PreID:"Case",HmiOptions:[{PreDataKey:"St",Type:"ArrayIDx",Arr:G_RES[G_LANG]["CompClassStates"],NodeAttr:"class",DefaultValue:"ui-bar ui-bar-a ui-state-stop"},{PreDataKey:"Al",Type:"BitFunc",Func:onBitFuncAlarmLog,DefaultValue:0,RiseEdge:true}]},{ID:3,Title:"K3::"+G_RES[G_LANG]["Mythos"],Class:"Compressor",PreID:"Case",HmiOptions:[{PreDataKey:"St",Type:"ArrayIDx",Arr:G_RES[G_LANG]["CompClassStates"],NodeAttr:"class",DefaultValue:"ui-bar ui-bar-a ui-state-stop"},{PreDataKey:"Al",Type:"BitFunc",Func:onBitFuncAlarmLog,DefaultValue:0,RiseEdge:true}]},{ID:4,Title:"K4::"+G_RES[G_LANG]["Wilden"],Class:"Compressor",PreID:"Case",HmiOptions:[{PreDataKey:"St",Type:"ArrayIDx",Arr:G_RES[G_LANG]["CompClassStates"],NodeAttr:"class",DefaultValue:"ui-bar ui-bar-a ui-state-stop"},{PreDataKey:"Al",Type:"BitFunc",Func:onBitFuncAlarmLog,DefaultValue:0,RiseEdge:true}]},{ID:5,Title:"K5::"+G_RES[G_LANG]["Dnd"],Class:"Compressor",PreID:"Case",HmiOptions:[{PreDataKey:"St",Type:"ArrayIDx",Arr:G_RES[G_LANG]["CompClassStates"],NodeAttr:"class",DefaultValue:"ui-bar ui-bar-a ui-state-stop"},{PreDataKey:"Al",Type:"BitFunc",Func:onBitFuncAlarmLog,DefaultValue:0,RiseEdge:true}]},{ID:6,Title:"K6::"+G_RES[G_LANG]["Ceccato"],Class:"Compressor",PreID:"Case",HmiOptions:[{PreDataKey:"St",Type:"ArrayIDx",Arr:G_RES[G_LANG]["CompClassStates"],NodeAttr:"class",DefaultValue:"ui-bar ui-bar-a ui-state-stop"},{PreDataKey:"Al",Type:"BitFunc",Func:onBitFuncAlarmLog,DefaultValue:0,RiseEdge:true}]},{ID:7,Title:"K7::"+G_RES[G_LANG]["Hitachi"],Class:"Compressor",PreID:"Case",HmiOptions:[{PreDataKey:"St",Type:"ArrayIDx",Arr:G_RES[G_LANG]["CompClassStates"],NodeAttr:"class",DefaultValue:"ui-bar ui-bar-a ui-state-stop"},{PreDataKey:"Al",Type:"BitFunc",Func:onBitFuncAlarmLog,DefaultValue:0,RiseEdge:true}]},{ID:8,Title:G_RES[G_LANG]["Total"],Class:"Total",PreID:"Case"}];var c={Compressor:{TableRows:[{PreID:"To",HmiOptions:[{PreDataKey:"To",Type:"Number",Offset:1,Round:1}],Title:G_RES[G_LANG]["To"],Title_t:G_RES[G_LANG]["To_t"],MUnit:G_RES[G_LANG]["DegC"]},{PreID:"Ts",HmiOptions:[{PreDataKey:"Ts",Type:"Number",Offset:1,Round:1}],Title:G_RES[G_LANG]["Ts"],Title_t:G_RES[G_LANG]["Ts_t"],MUnit:G_RES[G_LANG]["DegC"]},{PreID:"Tv",HmiOptions:[{PreDataKey:"Tv",Type:"Number",Offset:1,Round:1}],Title:G_RES[G_LANG]["Tv"],Title_t:G_RES[G_LANG]["Tv_t"],MUnit:G_RES[G_LANG]["DegC"]},{PreID:"I",HmiOptions:[{PreDataKey:"I",Type:"Number",Offset:1,Round:1}],Title:G_RES[G_LANG]["I"],Title_t:G_RES[G_LANG]["I_t"],MUnit:G_RES[G_LANG]["Amp"]},{PreID:"O",HmiOptions:[{PreDataKey:"Ws",Type:"ArrayIDx",Arr:G_RES[G_LANG]["BooStates"],Bit:0,Inverted:true}],Title:G_RES[G_LANG]["O"],Title_t:G_RES[G_LANG]["O_t"],MUnit:G_RES[G_LANG]["None"]},{PreID:"Fa",HmiOptions:[{PreDataKey:"Ws",Type:"ArrayIDx",Arr:G_RES[G_LANG]["BooStates"],Bit:4,Inverted:true}],Title:G_RES[G_LANG]["Fa"],Title_t:G_RES[G_LANG]["Fa_t"],MUnit:G_RES[G_LANG]["None"]},{PreID:"Mo",HmiOptions:[{PreDataKey:"Ws",Type:"ArrayIDx",Arr:G_RES[G_LANG]["MoStates"],Bit:8}],Title:G_RES[G_LANG]["Mo"],Title_t:G_RES[G_LANG]["Mo_t"],MUnit:G_RES[G_LANG]["None"]},{PreID:"St",HmiOptions:[{PreDataKey:"St",Type:"ArrayIDx",Arr:G_RES[G_LANG]["CompStates"]},{PreDataKey:"Al",Type:"ArrayIDx",Arr:G_RES[G_LANG]["AlarmTitleStates"],NodeAttr:"title"}],MUnit:G_RES[G_LANG]["None"],Colspan:true}],BitLampBlink:[{PreID:"Al",HmiOptions:[{PreDataKey:"Al",Type:"BitLampBlink",DefaultValue:0}]}]},Total:{TableRows:[{PreID:"P",HmiOptions:[{DataKey:"P",Type:"Number",Offset:10,Round:1}],Title:G_RES[G_LANG]["P"],Title_t:G_RES[G_LANG]["P_t"],MUnit:G_RES[G_LANG]["Bar"],Kpi:true},{PreID:"Tc",HmiOptions:[{DataKey:"Tc",Type:"Number",Offset:1,Round:1}],Title:G_RES[G_LANG]["Tc"],Title_t:G_RES[G_LANG]["Tc_t"],MUnit:G_RES[G_LANG]["DegC"]},{PreID:"Tr",HmiOptions:[{DataKey:"Tr",Type:"Number",Offset:1,Round:1}],Title:G_RES[G_LANG]["Tr"],Title_t:G_RES[G_LANG]["Tr_t"],MUnit:G_RES[G_LANG]["DegC"]},{PreID:"RampPlc",HmiOptions:[{DataKey:"RampPlc",Type:"String"}],Title:G_RES[G_LANG]["Plc"],Title_t:G_RES[G_LANG]["Plc_t"],MUnit:G_RES[G_LANG]["None"]}]}};if(typeof HMI=="function"){G_HMI=new HMI();G_HMI.Options={};G_HMI.DefaultValue=G_RES[G_LANG]["None"]}if(typeof jsLog=="function"){G_LOG=new jsLog("LogTable");G_LOG.LimRows=30;G_LOG.AllowRotate=true;G_LOG.AllowCurrentStamp=true;G_LOG.CaseID="LogCase"}var a=$("#"+G_ROOT_CASE);initCases(a,b,c);if(G_HMI){G_HMI.init()}initPopupBasic();initFormSet();refreshWsServerDesc();$("#FormSetConnect").trigger("click");G_WATCHDOG_TIMER=setInterval(onWatchdogTimerElapsed,G_WATCHDOG_TM*1000)};